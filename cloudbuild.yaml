steps:
  # Build the Caddy Docker image
  - name: gcr.io/cloud-builders/docker
    id: Build Caddy image
    args:
      - build
      - --build-arg
      - caddy_image=$_BUILDERS_REPO/$_CADDY_IMAGE
      - -t
      - $_APP_REPO/$_SERVICE_NAME:$_ENVIRONMENT
      - --no-cache
      - .
  # Push the Caddy Docker iamge
  - name: gcr.io/cloud-builders/docker
    id: Push Caddy image
    args:
      - push
      - $_APP_REPO/$_SERVICE_NAME:$_ENVIRONMENT
  # Update Cloud Run service
  - name: gcr.io/cloud-builders/gcloud
    id: Update Cloud Run service
    entrypoint: gcloud
    args:
      - run
      - services
      - update
      - $_SERVICE_NAME
      - --platform=managed
      - --image=$_APP_REPO/$_SERVICE_NAME:$_ENVIRONMENT
      - --region=$_DEPLOY_REGION
      - --quiet
      - --async
